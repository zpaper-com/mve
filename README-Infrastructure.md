# MVE Project - AWS Infrastructure Setup

This repository contains the AWS CDK infrastructure code for the MVE (Medical Verification Engine) project, a React-based PDF form viewer and workflow application.

## Architecture Overview

The infrastructure consists of:

- **VPC**: Custom VPC with public/private subnets and NAT Gateway
- **Database**: RDS PostgreSQL (Single AZ, db.t3.small) with automated backups
- **Cache**: ElastiCache Redis (cache.t3.micro) for session storage
- **Storage**: Three S3 buckets for static assets, documents, and attachments
- **CDN**: CloudFront distribution with path-based routing
- **Compute**: ECS Fargate cluster with Application Load Balancer
- **Container Registry**: ECR repository for backend Docker images
- **Security**: IAM roles, security groups, and SSL certificate
- **Monitoring**: CloudWatch logs, metrics, and alarms

## Prerequisites

1. **AWS CLI**: Install and configure with appropriate credentials
   ```bash
   aws configure
   ```

2. **Node.js**: Version 18 or later
   ```bash
   node --version
   ```

3. **AWS CDK**: Install globally
   ```bash
   npm install -g aws-cdk
   ```

4. **TypeScript**: Install globally (optional, included in devDependencies)
   ```bash
   npm install -g typescript
   ```

## Quick Start

1. **Clone and Setup**
   ```bash
   git clone <repository-url>
   cd mve-proto
   npm install
   ```

2. **Deploy Infrastructure**
   ```bash
   ./deploy.sh
   ```

   This script will:
   - Check prerequisites
   - Install dependencies
   - Bootstrap CDK (if needed)
   - Build the TypeScript project
   - Deploy all stacks in the correct order
   - Display stack outputs

## Manual Deployment Steps

If you prefer to deploy manually:

1. **Install Dependencies**
   ```bash
   npm install
   ```

2. **Bootstrap CDK** (first time only)
   ```bash
   cdk bootstrap
   ```

3. **Build Project**
   ```bash
   npm run build
   ```

4. **Deploy Stacks** (in order)
   ```bash
   cdk deploy MveNetworkingStack
   cdk deploy MveDataStack
   cdk deploy MveStorageStack
   cdk deploy MveComputeStack
   ```

## Stack Details

### MveNetworkingStack
- VPC with public/private/database subnets across 2 AZs
- NAT Gateway for private subnet internet access
- Security groups with least-privilege access
- VPC endpoints to reduce NAT Gateway costs

### MveDataStack
- RDS PostgreSQL 15.6 (Single AZ for cost optimization)
- ElastiCache Redis 7.0 cluster
- Automated database schema creation
- Secrets Manager for database credentials

### MveStorageStack
- S3 buckets with appropriate lifecycle policies
- CloudFront distribution with multiple origins
- SSL certificate for *.zpaper.com
- Route 53 A record for mve.zpaper.com

### MveComputeStack
- ECS Fargate cluster with auto-scaling
- Application Load Balancer with health checks
- ECR repository for container images
- IAM roles and policies
- CloudWatch monitoring and alarms

## Configuration

### Environment Variables

The following environment variables are configured in the ECS task:

```bash
NODE_ENV=production
PORT=3000
AWS_REGION=us-east-1
S3_STATIC_BUCKET=mve-zpaper-static
S3_DOCUMENTS_BUCKET=mve-zpaper-documents
S3_ATTACHMENTS_BUCKET=mve-zpaper-attachments
CLOUDFRONT_DISTRIBUTION_ID=<auto-generated>
REDIS_HOST=<auto-generated>
REDIS_PORT=6379
DATABASE_HOST=<auto-generated>
```

### Secrets

Database credentials are stored in AWS Secrets Manager:
- Secret name: `mve/database/credentials`
- Contains: `username` and `password`

## Database Schema

The following tables are automatically created:

```sql
-- Workflow Sessions
CREATE TABLE workflow_sessions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    document_url VARCHAR(500) NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    status VARCHAR(50) DEFAULT 'active',
    metadata JSONB
);

-- Recipients
CREATE TABLE recipients (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    session_id UUID REFERENCES workflow_sessions(id),
    order_index INTEGER NOT NULL,
    recipient_type VARCHAR(50) NOT NULL,
    party_name VARCHAR(255),
    email VARCHAR(255),
    mobile VARCHAR(20),
    npi VARCHAR(10),
    unique_url VARCHAR(100) UNIQUE NOT NULL,
    status VARCHAR(50) DEFAULT 'pending',
    accessed_at TIMESTAMP,
    completed_at TIMESTAMP,
    form_data JSONB,
    created_at TIMESTAMP DEFAULT NOW()
);

-- Attachments
CREATE TABLE attachments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    session_id UUID REFERENCES workflow_sessions(id),
    recipient_id UUID REFERENCES recipients(id),
    file_name VARCHAR(255) NOT NULL,
    file_type VARCHAR(50) NOT NULL,
    file_size INTEGER NOT NULL,
    s3_key VARCHAR(500) NOT NULL,
    uploaded_at TIMESTAMP DEFAULT NOW(),
    uploaded_by UUID REFERENCES recipients(id)
);
```

## Post-Deployment Steps

After infrastructure deployment:

1. **Update CloudFront Origins**
   - Get the ALB DNS name from stack outputs
   - Update CloudFront distribution origins to use actual ALB endpoint

2. **Build and Deploy Backend**
   ```bash
   # Get ECR repository URI from outputs
   ECR_URI=$(aws cloudformation describe-stacks --stack-name MveComputeStack --query 'Stacks[0].Outputs[?OutputKey==`EcrRepositoryUri`].OutputValue' --output text)
   
   # Build and push Docker image
   docker build -t mve-backend .
   docker tag mve-backend:latest $ECR_URI:latest
   aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin $ECR_URI
   docker push $ECR_URI:latest
   
   # Update ECS service
   aws ecs update-service --cluster mve-cluster --service mve-backend-service --force-new-deployment
   ```

3. **Deploy Frontend**
   ```bash
   # Build React app
   cd frontend
   npm run build
   
   # Upload to S3
   aws s3 sync dist/ s3://mve-zpaper-static/ --delete
   
   # Invalidate CloudFront
   DISTRIBUTION_ID=$(aws cloudformation describe-stacks --stack-name MveStorageStack --query 'Stacks[0].Outputs[?OutputKey==`DistributionId`].OutputValue' --output text)
   aws cloudfront create-invalidation --distribution-id $DISTRIBUTION_ID --paths "/*"
   ```

4. **Configure DNS**
   - Update your DNS provider to point zpaper.com to Route 53 name servers
   - Or manually create A record for mve.zpaper.com pointing to CloudFront distribution

## Monitoring and Maintenance

### CloudWatch Alarms

The following alarms are configured:
- High CPU utilization (>80%)
- High memory utilization (>85%)
- Unhealthy targets in ALB target group

### Auto Scaling

ECS service auto-scales based on:
- CPU utilization (target: 70%)
- Memory utilization (target: 80%)
- Request count per target (target: 1000 requests)

### Backups

- RDS: 7-day automated backups with point-in-time recovery
- S3: Versioning enabled with lifecycle policies

## Cost Optimization

### Current Configuration (MVP)

- Single AZ RDS deployment (~50% cost savings)
- Small instance sizes (t3.small for RDS, t3.micro for Redis)
- Single NAT Gateway
- Standard CloudWatch monitoring

### Estimated Monthly Costs

| Service | Configuration | Est. Cost |
|---------|--------------|-----------|
| RDS PostgreSQL | db.t3.small, Single AZ | $25 |
| ElastiCache Redis | cache.t3.micro | $15 |
| ECS Fargate | 2 tasks, 1vCPU, 2GB | $50 |
| Application Load Balancer | Standard | $20 |
| NAT Gateway | 1 gateway | $45 |
| CloudFront | 1TB/month | $85 |
| S3 Storage | 100GB | $2.50 |
| VPC Endpoints | 5 endpoints | $15 |
| **Total** | | **~$257.50** |

### Future Optimizations

- Reserved Instances for predictable workloads
- Spot Instances for development environments
- Multi-AZ deployment for production
- Enhanced monitoring and custom dashboards

## Troubleshooting

### Common Issues

1. **Stack Deployment Fails**
   - Check IAM permissions
   - Verify AWS CLI configuration
   - Ensure CDK is bootstrapped

2. **ECS Tasks Not Starting**
   - Check ECR repository has images
   - Verify security group rules
   - Check CloudWatch logs

3. **Database Connection Issues**
   - Verify security group allows port 5432
   - Check Secrets Manager permissions
   - Ensure database is in correct subnets

4. **CloudFront Not Serving Content**
   - Verify SSL certificate is validated
   - Check origin configurations
   - Ensure S3 bucket permissions

### Useful Commands

```bash
# Check stack status
cdk list
cdk diff

# View CloudWatch logs
aws logs describe-log-groups
aws logs tail /ecs/mve-backend --follow

# Check ECS service status
aws ecs describe-services --cluster mve-cluster --services mve-backend-service

# View RDS status
aws rds describe-db-instances --db-instance-identifier mve-postgresql
```

## Security Considerations

- All data encrypted at rest and in transit
- Security groups follow least-privilege principle
- Database in private subnets with no internet access
- IAM roles with minimal required permissions
- VPC endpoints to avoid internet traffic for AWS services
- CloudFront with security headers enabled

## Disaster Recovery

- RDS automated backups with 7-day retention
- S3 versioning enabled for critical buckets
- Multi-AZ deployment available for production upgrade
- Infrastructure as Code for rapid rebuilding
- CloudTrail enabled for audit logging

## Support

For infrastructure issues:
1. Check CloudWatch logs and alarms
2. Review CloudFormation stack events
3. Verify AWS service limits
4. Contact AWS support if needed

---

## License

This infrastructure code is part of the MVE project. See main project documentation for licensing information.